<!DOCTYPE HTML>
<html>

<head>
    <script type="text/javascript">
        window.onload = function() {
            var updateCount = 0;
            var seekCount = 0;    
    		/*var counter = setInterval(timer, 10);
    
    		function timer()
    		{
				if(seekCount < updateCount) {
					seekCount += Math.min(11, updateCount - seekCount);				
         			document.getElementById("timer").innerHTML=seekCount;
         		} 
     		} */       
        
            var paintTime = [];
            var roundTripTime = [];
            var averagePaintTime = [];
            var averageRoundTripTime = [];
            var rowsChanged = [];            
       		var latencyDivision = [];

            var latencyDivisionChart = new CanvasJS.Chart("latencyDivision", {
                creditText: "",            
                title: {
                    text: "Latency Proportions"
                },
                data: [{
                    type: "pie",
                    showInLegend: true,
                    dataPoints: latencyDivision

                }]
            });

            latencyDivisionChart.render();
            
            var paintTimeChart = new CanvasJS.Chart("paintTime", {
                creditText: "",
                /*backgroundColor: "#f5deb3",*/
                title: {
                    text: "Paint Time"
                },
                data: [{
                    /*color: "#ff0000",*/
                    type: "line",
                    dataPoints: paintTime
                }, {
                    /*color: "#00ff00",*/
                    type: "line",
                    dataPoints: averagePaintTime
                }, ]
            });
            var roundTripTimeChart = new CanvasJS.Chart("roundTripTime", {
                creditText: "",
                /* backgroundColor: "#f5aaff",*/
                title: {
                    text: "Round Trip Time"
                },
                data: [{
                        /* color: "#000000",*/
                        type: "line",
                        dataPoints: roundTripTime
                    }, {
                        /*color: "#00ff00",*/
                        type: "line",
                        dataPoints: paintTime
                    }, {
                        /*color: "#00ff00",*/
                        type: "line",
                        dataPoints: averageRoundTripTime
                    },

                ]
            });
            var rowsChangedChart = new CanvasJS.Chart("rowsChanged", {
                creditText: "",
                /*   backgroundColor: "#f5aa23",*/
                title: {
                    text: "Price Changes"
                },
                data: [{
                    /*color: "#0000ff",*/
                    type: "line",
                    dataPoints: rowsChanged
                }]
            });
            var expression = "[\\?&]user=([^&#]*)";
            var regex = new RegExp(expression);
            var results = regex.exec(window.location.href);
            var websocket = new WebSocket("ws://localhost:6060/telemetry?user=" + results[1]);

            websocket.onmessage = function(evt) {
                var data = evt.data.split(":");
                var point = data[1].split(",");
                var chart = null;
                var series = null;

                if (data[0] == 'paintTime') {
                    chart = paintTimeChart;
                    series = paintTime;
                }
                if (data[0] == 'roundTripTime') {
                    chart = roundTripTimeChart;
                    series = roundTripTime;
                }
                if (data[0] == 'rowsChanged') {
                    chart = rowsChangedChart;
                    series = rowsChanged;
                    updateCount += parseInt(point[1]);
                }
                if (data[0] == 'averageRoundTripTime') {
                    chart = roundTripTimeChart;
                    series = averageRoundTripTime;                    
                    latencyDivision[0] = { y: parseFloat(point[1]), legendText: "Network"};
					latencyDivisionChart.render();
                }
                if (data[0] == 'averagePaintTime') {
                    chart = paintTimeChart;
                    series = averagePaintTime;
                    latencyDivision[1] = { y: parseFloat(point[1]), legendText: "Paint"};
					latencyDivisionChart.render();                    
                }
                series.push({
                    x: new Date(parseInt(point[0])),
                    y: parseFloat(point[1]),
                });

                if (series.length > 500) {
                    series.shift();
                }
                chart.render();
            };
        }
    </script>
    <script type="text/javascript" src="js/canvasjs.min.js"></script>
</head>

<body style="height: 100%; margin: 0; background-color: #ffffff;">
    <div id="mainLayout" style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;"></div>
    <table cellspacing="20" width="100%">
        <tr>        	        	
            <td width="20%">
            	<table width='100%' height='100%'>
            		<tr><td><span id='timer'></span></td></tr>
                	<tr><td><div id="latencyDivision" style="height: 300px; width:100%;"></div></td></tr>
                </table>
            </td>
            <td width="80%">
                <table cellspacing="20" width="100%">
                    <tr>
                        <td>
                            <div id="paintTime" style="height: 300px; width:100%;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="roundTripTime" style="height: 300px; width:100%;"></div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="rowsChanged" style="height: 300px; width:100%;"></div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
</body>

</html>